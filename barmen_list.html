<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Бармен</title>

<style>
body{
    background:#000;
    color:#fff;
    font-family:Arial;
    padding:20px;
}

#list{
    max-width:700px;
    margin:auto;
}

.card{
    border:1px solid #333;
    padding:20px;
    margin-bottom:22px;
    border-radius:16px;
    text-align:center;
}

.name{
    font-size:26px;
    font-weight:700;
    margin-bottom:10px;
}

.photo{
    width:100%;
    max-width:320px;
    border-radius:14px;
    margin:0 auto 14px auto;
    display:block;
}

.ingredients{
    text-align:left;
    margin-top:10px;
}

.line{
    display:flex;
    justify-content:space-between;
    margin-bottom:4px;
}

.total{
    margin-top:12px;
    font-weight:bold;
    color:#7CFC00;
}

.tools{
    color:#7CFC00;
    margin-top:10px;
}

.recipe{
    color:#aaa;
    margin-top:12px;
}

input{
    width:60px;
    padding:6px;
    margin-top:10px;
    text-align:center;
}
</style>
</head>

<body>

<h1 style="text-align:center">Панель бармена</h1>
<div style="text-align:center;margin-bottom:25px">
Себестоимость вечера: <span id="sum">0</span> ₽
</div>

<div id="list"></div>

<script>

const SHEET_ID="1CceZ3cIic_k9Z9GnXg_wOzoUGdYonzVkfypmSzf_ln8";

const techURL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=БАР_КУХНЯ`;
const menuURL=`https://opensheet.elk.sh/${SHEET_ID}/MENU`;
const storeURL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Магазин`;

let cocktails=[];
let prices={};
let photos={};
let total=0;

Promise.all([
    fetch(techURL).then(r=>r.text()),
    fetch(menuURL).then(r=>r.json()),
    fetch(storeURL).then(r=>r.text())
])
.then(([techTxt,menuData,storeTxt])=>{

    // фото
    menuData.forEach(r=>{
        photos[r.Коктейль]=r.Фото;
    });

    // цены ингредиентов
    const storeJson=JSON.parse(storeTxt.substr(47).slice(0,-2));
    storeJson.table.rows.forEach(r=>{
        const name=r.c[0]?.v;
        const price=r.c[5]?.v;
        if(name) prices[name]=parseFloat(price)||0;
    });

    // техкарты
    const json=JSON.parse(techTxt.substr(47).slice(0,-2));
    const rows=json.table.rows;

    let current=null;

    rows.forEach(r=>{
        const c=r.c;

        const id = c[0]?.v;
        const name = c[1]?.v;
        const cost = parseFloat(c[3]?.v)||0;
        const ing = c[5]?.v;
        const qty = parseFloat(c[6]?.v)||0;
        const unit = c[7]?.v;
        const tool = c[9]?.v;
        const recipe = c[10]?.v;

        if(id){
            current={
                name:name,
                cost:cost,
                recipe:recipe||"",
                tools:[],
                ings:[],
                photo:photos[name] || ""
            };
            cocktails.push(current);
        }

        if(ing){
            const unitPrice = prices[ing] || 0;
            const sum = unitPrice * qty;

            current?.ings.push({
                text:`${ing} ${qty} ${unit}`,
                price:sum
            });
        }

        if(tool){
            current?.tools.push(tool);
        }
    });

    render();
});

function render(){
    const list=document.getElementById("list");
    list.innerHTML="";

    cocktails.forEach((c,i)=>{

        let ingHTML="";
        let cocktailSum=0;

        c.ings.forEach(x=>{
            cocktailSum+=x.price;
            ingHTML+=`
            <div class="line">
                <div>${x.text}</div>
                <div>${x.price.toFixed(2)} ₽</div>
            </div>`;
        });

        list.innerHTML+=`
        <div class="card">

            <div class="name">${c.name}</div>

            ${c.photo ? `<img src="${c.photo}" class="photo">` : ""}

            <div class="ingredients">
                ${ingHTML}
            </div>

            <div class="total">
                Стоимость коктейля: ${cocktailSum.toFixed(2)} ₽
            </div>

            <div class="tools">${c.tools.join(" • ")}</div>
            <div class="recipe">${c.recipe}</div>

            <br>
            Сделано:
            <br>
            <input type="number" value="0" min="0" onchange="calc()">

        </div>`;
    });
}

function calc(){
    total=0;
    document.querySelectorAll("input").forEach((inp,i)=>{
        total += (parseInt(inp.value)||0)*cocktails[i].cost;
    });
    document.getElementById("sum").innerText=total.toFixed(2);
}

</script>
</body>
</html>
